<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inbox | QuMail</title>
    <meta name="description" content="Inbox for QuMail, the most intelligent email client in the world." />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&family=Inter:wght@400;500;700&display=swap');
        body {
            --primary: hsl(0, 0%, 100%); --secondary: hsl(216, 4%, 51%); --accent: hsl(22, 100%, 51.6%); --accent-hover: hsl(37, 100%, 76%); --background: hsl(0, 0%, 4%); --background-hover: hsl(221, 12%, 14%); --foreground: hsl(222, 19%, 86%); --card: hsl(0, 0%, 10%); --border: hsl(221, 12%, 14%);
            font-family: 'Geist Mono', monospace;
            background-color: var(--background); color: var(--foreground);
        }
        #background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: 0; object-fit: cover; }
        .content-wrapper { position: relative; z-index: 1; }
        .sidebar-bg { background-color: rgba(10, 10, 10, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .main-bg { background-color: rgba(4, 4, 4, 0.5); }
        .text-primary { color: var(--primary); } .text-secondary { color: var(--secondary); } .bg-accent { background-color: var(--accent); } .hover\:bg-accent-hover:hover { background-color: var(--accent-hover); } .border-border { border-color: rgba(40, 40, 40, 0.6); }
        .email-item { transition: background-color 0.2s ease-in-out; }
        .email-item:hover { background-color: var(--background-hover); }
        .bg-background-hover { background-color: var(--background-hover) !important; }
        .email-full-body { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--foreground); font-family: 'Inter', sans-serif; }
        .email-full-body a { color: var(--accent); }

        /* Styles for the star icon toggle */
        .star-btn .star-empty { display: block; }
        .star-btn .star-filled { display: none; }
        .star-btn.starred .star-empty { display: none; }
        .star-btn.starred .star-filled { display: block; color: hsl(var(--accent)); }
        
        /* Styling for checkboxes */
        .email-checkbox {
            -webkit-appearance: none;
            appearance: none;
            background-color: transparent;
            width: 1.15em;
            height: 1.15em;
            border: 2px solid var(--secondary);
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block; /* Ensure it respects width/height */
            vertical-align: middle; /* Align with text */
            margin-right: 0.5rem; /* Space between checkbox and star/content */
        }
        .email-checkbox:checked {
            background-color: var(--accent);
            border-color: var(--accent);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="dark antialiased">
    <video autoplay loop muted playsinline id="background-video">
        <source src="{{ url_for('static', filename='videos/blackhole-720p.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="content-wrapper flex h-screen w-full">
        <aside id="sidebar" class="w-64 flex-shrink-0 border-r border-border sidebar-bg p-4 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold text-primary">QuMail</h1>
                <button id="close-btn" class="md:hidden p-1 text-secondary hover:text-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <a href="{{ url_for('compose') }}" class="w-full flex items-center justify-center gap-3 text-center py-4 mb-8 rounded-full bg-accent hover:bg-accent-hover text-black font-bold text-base transition-all shadow-lg shadow-accent/30 hover:shadow-xl hover:shadow-accent/40">
                <svg class="size-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                <span>New Message</span>
            </a>
            
            <nav class="flex flex-col space-y-2 flex-grow overflow-y-auto pr-2">
                <a href="{{ url_for('inbox', folder='inbox') }}" class="flex items-center gap-3 rounded-lg px-4 py-2 transition-colors {% if current_folder == 'Inbox' %} text-primary font-semibold bg-background-hover {% else %} text-secondary hover:text-primary hover:bg-background-hover {% endif %}">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                    <span>Inbox</span>
                </a>
                <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>Starred</span>
                </a>
                <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span>Snoozed</span>
                </a>
                <a href="{{ url_for('inbox', folder='drafts') }}" class="flex items-center gap-3 rounded-lg px-4 py-2 transition-colors {% if current_folder == 'Drafts' %} text-primary font-semibold bg-background-hover {% else %} text-secondary hover:text-primary hover:bg-background-hover {% endif %}">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    <span>Drafts</span>
                </a>
                <a href="{{ url_for('inbox', folder='sent') }}" class="flex items-center gap-3 rounded-lg px-4 py-2 transition-colors {% if current_folder == 'Sent' %} text-primary font-semibold bg-background-hover {% else %} text-secondary hover:text-primary hover:bg-background-hover {% endif %}">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2 11 13"/><path d="m22 2-7 20-4-9-9-4Z"/></svg>
                    <span>Sent</span>
                </a>
                <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 10.5a2.5 2.5 0 0 0 5 0V7.5a2.5 2.5 0 0 0-5 0v3Z"/><path d="M8.5 7.5V10H16V7.5a4.5 4.5 0 1 0-9 0Z"/><path d="M12 17.5V20"/><path d="M8 12.5a2.5 2.5 0 0 0 5 0V7.5a2.5 2.5 0 0 0-5 0Z"/></svg>
                    <span>Important</span>
                </a>
                
                <div class="border-t border-border mt-4 pt-4 space-y-2">
                    <button class="flex items-center gap-3 w-full text-left rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors" id="less-button">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                        <span>Less</span>
                    </button>
                    <div id="less-menu" class="hidden flex flex-col space-y-2 pl-4">
                        <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                            <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                            <span>All Mail</span>
                        </a>
                        <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                            <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8-3.8L21 3"/></svg>
                            <span>Chats</span>
                        </a>
                        <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                            <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22V2L7 22V2"/></svg>
                            <span>Scheduled</span>
                        </a>
                        <a href="{{ url_for('inbox', folder='spam') }}" class="flex items-center gap-3 rounded-lg px-4 py-2 transition-colors {% if current_folder == 'Spam' %} text-primary font-semibold bg-background-hover {% else %} text-secondary hover:text-primary hover:bg-background-hover {% endif %}">
                            <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                            <span>Spam</span>
                        </a>
                        <a href="{{ url_for('inbox', folder='bin') }}" class="flex items-center gap-3 rounded-lg px-4 py-2 transition-colors {% if current_folder == 'Bin' %} text-primary font-semibold bg-background-hover {% else %} text-secondary hover:text-primary hover:bg-background-hover {% endif %}">
                            <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            <span>Bin</span>
                        </a>
                    </div>
                </div>

                <div class="border-t border-border mt-4 pt-4 space-y-2">
                    <p class="text-sm font-semibold text-secondary px-4 pb-1">Categories</p>
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                        <span>Promotions</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10h.01"/><path d="M11 10h.01"/><path d="M15 10h.01"/><path d="M7 14h.01"/><path d="M11 14h.01"/><path d="M15 14h.01"/><path d="M7 18h.01"/><path d="M11 18h.01"/><path d="M15 18h.01"/><path d="M18 2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zM4 2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zM18 16h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2zM4 16h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z"/></svg>
                        <span>Social</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 17H2"/><path d="M22 9H2"/><path d="M12 22V2"/></svg>
                        <span>Updates</span>
                    </a>
                </div>

                <div class="border-t border-border mt-4 pt-4 space-y-2">
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span>Manage Subscriptions</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11.5V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h4.5"/><path d="M12 22h.01"/></svg>
                        <span>Manage Labels</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                        <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        <span>Create new label</span>
                    </a>
                </div>
            </nav>
            
            <div class="mt-auto pt-4 border-t border-border">
                <a href="#" class="w-full text-left flex items-center gap-3 rounded-lg px-4 py-2 text-accent hover:text-accent-hover hover:bg-background-hover transition-colors font-bold">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 5V3a2 2 0 0 0-2-2h-7.1L7 3.9V5M5 5H3a2 2 0 0 0-2 2v3.1L5 7h7.1L17 3.9V5M17 5V3a2 2 0 0 1 2-2h.1L23 3.9V5M5 7H3a2 2 0 0 0-2 2v3.1L5 11h7.1L17 7.9V9M17 9V7a2 2 0 0 1 2-2h.1L23 7.9V9M5 11H3a2 2 0 0 0-2 2v3.1L5 15h7.1L17 11.9V13M17 13V11a2 2 0 0 1 2-2h.1L23 11.9V13M5 15H3a2 2 0 0 0-2 2v3.1L5 19h7.1L17 15.9V17M17 17V15a2 2 0 0 1 2-2h.1L23 15.9V17M12 23h.01"/><path d="M12 23h.01"/></svg>
                    <span>Upgrade</span>
                </a>
                <a href="{{ url_for('logout') }}" class="w-full text-left flex items-center gap-3 rounded-lg px-4 py-2 text-secondary hover:text-primary hover:bg-background-hover transition-colors">
                    <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <main class="flex-1 min-w-0 flex flex-col main-bg">
            <header class="flex items-center justify-between p-4 border-b border-border">
                <div class="flex items-center gap-4">
                    <button id="menu-btn" class="md:hidden p-1 text-secondary hover:text-primary">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 class="text-xl font-semibold text-primary truncate">{{ current_folder }} for {{ user.info.name }}</h2>
                </div>
                <div class="flex items-center gap-4">
                    {% if user.info.picture %}<img src="{{ user.info.picture }}" alt="Profile" class="rounded-full w-8 h-8 cursor-pointer" title="{{ user.info.name }}">
                    {% elif user.info.name %}<img src="https://placehold.co/32x32/ffb900/000000?text={{ user.info.name[0]|upper }}" alt="Profile" class="rounded-full cursor-pointer" title="{{ user.info.name }}">{% endif %}
                </div>
            </header>

            <div id="action-bar" class="hidden items-center p-4 border-b border-border space-x-4">
                <p class="text-sm text-secondary"><span id="selection-count">0</span> selected</p>
                <button title="Archive" class="p-2 text-secondary hover:text-primary"><svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><path d="M10 12h4"/><path d="M22 4H2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/></svg></button>
                <button title="Report Spam" class="p-2 text-secondary hover:text-primary"><svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></button>
                <button id="delete-btn" title="Delete" class="p-2 text-secondary hover:text-primary"><svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
            </div>

            <div class="flex-1 overflow-y-auto">
                {% for message in messages %}
                    <div class="email-item p-4 border-b border-border cursor-pointer flex flex-col" data-message-id="{{ message.id }}" data-provider="{{ user.provider }}">
                        <div class="flex items-center gap-4">
                            <input type="checkbox" class="email-checkbox flex-shrink-0" onclick="event.stopPropagation();">
                            <button class="star-btn p-1 text-secondary hover:text-accent flex-shrink-0" onclick="event.stopPropagation();">
                                <svg class="star-empty size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <svg class="star-filled size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            </button>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-baseline justify-between">
                                    <p class="font-bold w-48 truncate text-primary">{{ message.sender }}</p>
                                    <div class="flex items-center gap-4 flex-shrink-0">
                                        <span class="text-secondary text-sm">{{ message.date }}</span>
                                        {% if message.attachment %}
                                        <a href="{{ url_for('download_attachment', provider=user.provider, message_id=message.id) }}" title="Download {{ message.attachment.filename }}" class="z-10 relative" onclick="event.stopPropagation();">
                                            <svg class="size-4 text-secondary" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l.79-.79m.79-4.52 6.2-6.2"/></svg>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="font-semibold text-primary mt-1 break-all truncate">{{ message.subject }}</p>
                                <p class="text-secondary text-sm mt-1 break-all">{{ message.snippet }}</p>
                            </div>
                        </div>
                        <div class="email-full-body max-h-96 overflow-y-auto break-words"></div>
                    </div>
                {% else %}
                    <div class="text-center p-10"><p class="text-secondary">This folder is empty.</p></div>
                {% endfor %}
            </div>
        </main>
    </div>

<div id="delete-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background-color: rgba(0,0,0,0.8); display: none;">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-sm w-full border border-border">
        <h3 class="text-lg font-bold text-primary text-center mb-2">Confirm Deletion</h3>
        <p class="text-secondary text-center mb-6">Are you sure you want to move the selected conversations to the bin? This action cannot be undone from QuMail.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete-btn" class="w-full py-2 bg-background-hover text-primary rounded-full font-bold transition-colors hover:bg-gray-700">Cancel</button>
            <button id="confirm-delete-btn" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded-full font-bold transition-colors">Delete</button>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div id="notification-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background-color: rgba(0,0,0,0.8); display: none;">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-sm w-full border border-border">
        {% for category, message in messages %}<p class="text-primary text-center mb-4 font-semibold">{{ message }}</p>{% endfor %}
        <button onclick="document.getElementById('notification-modal').style.display='none'" class="w-full py-2 bg-accent text-black rounded-full font-bold">Close</button>
    </div>
</div>
<script>document.getElementById('notification-modal').style.display = 'flex';</script>
{% endif %}
{% endwith %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Email Expansion Logic (Accordion) ---
    const emailItems = document.querySelectorAll('.email-item');
    emailItems.forEach(item => {
        item.addEventListener('click', function(event) {
            // Prevent expanding if checkbox or star was clicked
            if (event.target.classList.contains('email-checkbox') || event.target.closest('.star-btn')) {
                return;
            }

            const bodyContainer = this.querySelector('.email-full-body');
            const isVisible = bodyContainer.style.display === 'block';

            // Accordion Logic: Close all other open emails first
            emailItems.forEach(otherItem => {
                if (otherItem !== this) {
                    otherItem.querySelector('.email-full-body').style.display = 'none';
                }
            });

            // Toggle the clicked email
            if (isVisible) {
                bodyContainer.style.display = 'none';
                return;
            }

            // If body is already loaded, just show it
            if (bodyContainer.innerHTML.trim() !== '') {
                bodyContainer.style.display = 'block';
                return;
            }

            // Fetch and display the email body
            const messageId = this.dataset.messageId;
            const provider = this.dataset.provider;
            bodyContainer.innerHTML = '<p class="text-secondary">Loading...</p>';
            bodyContainer.style.display = 'block';

            fetch(`/api/message/${provider}/${messageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        bodyContainer.innerHTML = `<p class="text-red-400">Error: ${data.error}</p>`;
                    } else {
                        bodyContainer.innerHTML = data.body;
                    }
                })
                .catch(error => {
                    bodyContainer.innerHTML = `<p class="text-red-400">Failed to load email. Please try again.</p>`;
                    console.error('Error fetching email:', error);
                });
        });
    });

    // --- Video Playback Logic ---
    const video = document.getElementById('background-video');
    if (video) {
        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Video autoplay was prevented by the browser:", error);
                video.controls = false;
            });
        }
    }

    // --- Mobile Sidebar Toggle Logic ---
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menu-btn');
    const closeBtn = document.getElementById('close-btn');
    if (sidebar && menuBtn && closeBtn) {
        menuBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
        });

        closeBtn.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
        });
    }

    // --- Star Toggle Logic ---
    const starButtons = document.querySelectorAll('.star-btn');
    starButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('starred');
        });
    });

    // --- Contextual Action Bar Logic ---
    const checkboxes = document.querySelectorAll('.email-checkbox');
    const actionBar = document.getElementById('action-bar');
    const selectionCount = document.getElementById('selection-count');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checkedCount = document.querySelectorAll('.email-checkbox:checked').length;
            if (checkedCount > 0) {
                actionBar.style.display = 'flex';
                selectionCount.textContent = checkedCount;
            } else {
                actionBar.style.display = 'none';
            }
        });
    });
    
    // --- NEW: Email Deletion Logic ---
    const deleteBtn = document.getElementById('delete-btn');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    if (deleteBtn && deleteModal && confirmDeleteBtn && cancelDeleteBtn) {
        // Show the modal when the main delete button is clicked
        deleteBtn.addEventListener('click', () => {
            const checkedCount = document.querySelectorAll('.email-checkbox:checked').length;
            if (checkedCount > 0) {
                deleteModal.style.display = 'flex';
            }
        });

        // Hide the modal if "Cancel" is clicked
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.style.display = 'none';
        });

        // Handle the final confirmation
        confirmDeleteBtn.addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('.email-checkbox:checked');
            if (checkedBoxes.length === 0) {
                deleteModal.style.display = 'none';
                return;
            }

            const messageIds = Array.from(checkedBoxes).map(cb => cb.closest('.email-item').dataset.messageId);
            const provider = checkedBoxes[0].closest('.email-item').dataset.provider;

            // Give user feedback
            confirmDeleteBtn.textContent = 'Deleting...';
            confirmDeleteBtn.disabled = true;

            fetch('/api/delete_emails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: messageIds, provider: provider }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error.');
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete success:', data.message);
                // Remove the emails from the UI for instant feedback
                checkedBoxes.forEach(cb => {
                    cb.closest('.email-item').remove();
                });
                // Hide action bar since items are gone
                document.getElementById('action-bar').style.display = 'none';
            })
            .catch(error => {
                console.error('Error deleting emails:', error);
                alert('An error occurred while deleting emails. Please refresh and try again.');
            })
            .finally(() => {
                // Reset modal and button state
                deleteModal.style.display = 'none';
                confirmDeleteBtn.textContent = 'Delete';
                confirmDeleteBtn.disabled = false;
            });
        });
    }

    // --- Toggle "Less" / Expanded menu ---
    const lessButton = document.getElementById('less-button');
    const lessMenu = document.getElementById('less-menu');
    const lessIcon = lessButton.querySelector('svg');

    if (lessButton && lessMenu && lessIcon) {
        lessButton.addEventListener('click', () => {
            lessMenu.classList.toggle('hidden');
            // Rotate the arrow icon
            if (lessMenu.classList.contains('hidden')) {
                lessIcon.style.transform = 'rotate(0deg)';
            } else {
                lessIcon.style.transform = 'rotate(180deg)';
            }
        });
    }
});
</script>
</body>
</html>